<template>
  <lightning-card title="Data 360 Table Configurator" icon-name="standard:data_streams">
    <div slot="actions">
      <lightning-button label="New" onclick={handleNew} class="slds-m-right_x-small"></lightning-button>
      <lightning-button label="Delete" onclick={handleDeleteClick} disabled={isDeleteDisabled} variant="destructive-text" class="slds-m-right_x-small"></lightning-button>
      <lightning-button label="Save" onclick={handleSave} variant="brand" disabled={isSaveDisabled}></lightning-button>
    </div>

    <div class="slds-grid slds-gutters slds-p-around_medium">
      <!-- LEFT PANEL: Config Builder -->
      <div class="slds-col slds-size_1-of-2">
        <div class="slds-card slds-p-around_medium">
          <lightning-combobox
            label="Load Existing Config"
            value={selectedConfigId}
            options={configOptions}
            onchange={handleConfigSelect}
            placeholder="-- New Config --"
            class="slds-m-bottom_small"
          ></lightning-combobox>

          <lightning-input
            label="Config Name"
            value={configName}
            onchange={handleNameChange}
            required
            class="slds-m-bottom_small"
          ></lightning-input>

          <lightning-textarea
            label="Description"
            value={configDescription}
            onchange={handleDescriptionChange}
            max-length="500"
            class="slds-m-bottom_small"
          ></lightning-textarea>

          <div class="slds-m-bottom_small">
            <div class="slds-grid slds-grid_vertical-align-end slds-gutters_xx-small">
              <div class="slds-col slds-grow">
                <lightning-input
                  label="Data Cloud Object API Name"
                  value={objectApiNameInput}
                  placeholder="e.g. Client_Transmissions__dlm"
                  onchange={handleObjectNameChange}
                  onkeyup={handleObjectNameKeyUp}
                  field-level-help="Enter the full API name of a Data Cloud object (ending in __dll or __dlm) and click Load Fields"
                  data-id="object-name-input"
                ></lightning-input>
              </div>
              <div class="slds-col slds-no-flex">
                <lightning-button
                  label="Load Fields"
                  onclick={handleLoadFields}
                  disabled={isLoadFieldsDisabled}
                  variant="neutral"
                  icon-name="utility:refresh"
                ></lightning-button>
              </div>
              <template if:true={selectedObject}>
                <div class="slds-col slds-no-flex">
                  <lightning-button-icon
                    icon-name="utility:close"
                    alternative-text="Clear object"
                    variant="bare"
                    onclick={handleObjectClear}
                  ></lightning-button-icon>
                </div>
              </template>
            </div>
            <template if:true={selectedObject}>
              <div class="slds-text-color_success slds-m-top_xx-small slds-text-body_small">
                Object validated â€” {fieldCount} fields loaded
              </div>
            </template>
          </div>

          <template if:true={hasFields}>
            <div class="slds-m-bottom_small">
              <div class="slds-grid slds-grid_vertical-align-end slds-m-bottom_x-small">
                <h3 class="slds-text-heading_small slds-grow slds-align-middle">Fields</h3>
                <lightning-combobox
                  label="Filter fields"
                  value={fieldVisibilityFilter}
                  options={fieldVisibilityFilterOptions}
                  onchange={handleFieldVisibilityFilterChange}
                  variant="label-hidden"
                  class="slds-m-right_small field-filter-combo"
                ></lightning-combobox>
                <lightning-button label="Select All" onclick={handleSelectAll} variant="neutral" class="slds-m-right_xx-small"></lightning-button>
                <lightning-button label="Deselect All" onclick={handleDeselectAll} variant="neutral"></lightning-button>
              </div>
              <div class="slds-scrollable_y" style="max-height: 400px;">
                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped field-table">
                  <thead>
                    <tr class="slds-line-height_reset">
                      <th scope="col" style="width: 36px;"></th>
                      <th scope="col" style="width: 50px;">
                        <span class="slds-truncate">Visible</span>
                      </th>
                      <th scope="col">
                        <span class="slds-truncate">Field API Name</span>
                      </th>
                      <th scope="col">
                        <span class="slds-truncate">Label</span>
                      </th>
                      <th scope="col" style="width: 60px;">
                        <span class="slds-truncate">Sortable</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody ondragover={handleDragOver} ondrop={handleDrop}>
                    <template for:each={fieldsWithPosition} for:item="field">
                      <tr
                        key={field.fieldName}
                        draggable="true"
                        data-field-name={field.fieldName}
                        ondragstart={handleDragStart}
                        ondragend={handleDragEnd}
                        class="field-row"
                      >
                        <td class="drag-handle-cell">
                          <lightning-icon icon-name="utility:drag_and_drop" size="xx-small" alternative-text="Drag to reorder"></lightning-icon>
                        </td>
                        <td>
                          <lightning-input
                            type="checkbox"
                            checked={field.visible}
                            data-field-name={field.fieldName}
                            onchange={handleFieldVisibleChange}
                            variant="label-hidden"
                            label="Visible"
                          ></lightning-input>
                        </td>
                        <td>
                          <span class="slds-truncate">{field.fieldName}</span>
                        </td>
                        <td>
                          <lightning-input
                            value={field.label}
                            data-field-name={field.fieldName}
                            onchange={handleFieldLabelChange}
                            variant="label-hidden"
                            label="Label"
                          ></lightning-input>
                        </td>
                        <td>
                          <lightning-input
                            type="checkbox"
                            checked={field.sortable}
                            data-field-name={field.fieldName}
                            onchange={handleFieldSortableChange}
                            variant="label-hidden"
                            label="Sortable"
                          ></lightning-input>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </template>

          <template if:true={hasFields}>
            <div class="slds-grid slds-gutters_xx-small slds-m-bottom_small">
              <div class="slds-col slds-size_2-of-3">
                <lightning-combobox
                  label="Default Sort Field"
                  value={defaultSortField}
                  options={sortableFieldOptions}
                  onchange={handleDefaultSortFieldChange}
                  placeholder="-- None --"
                ></lightning-combobox>
              </div>
              <div class="slds-col slds-size_1-of-3">
                <lightning-combobox
                  label="Direction"
                  value={defaultSortDirection}
                  options={sortDirectionOptions}
                  onchange={handleDefaultSortDirectionChange}
                  disabled={isDefaultSortDirectionDisabled}
                ></lightning-combobox>
              </div>
            </div>
          </template>

          <lightning-input
            label="WHERE Clause"
            value={whereClause}
            onchange={handleWhereChange}
            placeholder="WHERE FieldName__c = 'value'"
            class="slds-m-bottom_small"
          ></lightning-input>

          <lightning-input
            type="number"
            label="Row Limit"
            value={rowLimit}
            onchange={handleLimitChange}
            min="1"
            max="2000"
            class="slds-m-bottom_small"
          ></lightning-input>

          <h3 class="slds-text-heading_small slds-m-bottom_x-small slds-m-top_small">Table Options</h3>
          <div class="slds-grid slds-wrap slds-m-bottom_small">
            <div class="slds-col slds-size_1-of-3">
              <lightning-input
                type="checkbox"
                label="Show Record Count"
                checked={showRecordCount}
                onchange={handleShowRecordCountChange}
              ></lightning-input>
            </div>
            <div class="slds-col slds-size_1-of-3">
              <lightning-input
                type="checkbox"
                label="Show Search"
                checked={showSearch}
                onchange={handleShowSearchChange}
              ></lightning-input>
            </div>
            <div class="slds-col slds-size_1-of-3">
              <lightning-input
                type="checkbox"
                label="Show Refresh"
                checked={showRefresh}
                onchange={handleShowRefreshChange}
              ></lightning-input>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL: Live Preview -->
      <div class="slds-col slds-size_1-of-2">
        <!-- Context Record Lookup -->
        <div class="slds-card slds-p-around_medium slds-m-bottom_small">
          <h3 class="slds-text-heading_small slds-m-bottom_small">Context Record (for $record tokens)</h3>
          <div class="slds-m-bottom_small context-object-search">
            <lightning-input
              label="Context Object"
              value={contextObjectSearchTerm}
              placeholder="Search for an object (e.g. Account)"
              onchange={handleContextObjectSearch}
              onkeyup={handleContextObjectKeyUp}
              onfocus={handleContextObjectFocus}
              onblur={handleContextObjectBlur}
              autocomplete="off"
              data-id="context-object-input"
            ></lightning-input>
            <template if:true={showContextObjectDropdown}>
              <div class="slds-dropdown slds-dropdown_left context-object-dropdown" role="listbox">
                <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                  <template for:each={contextObjectResults} for:item="obj">
                    <li key={obj.apiName} role="presentation" class="slds-listbox__item">
                      <div
                        class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small"
                        role="option"
                        data-api-name={obj.apiName}
                        data-label={obj.label}
                        onmousedown={handleContextObjectSelect}
                      >
                        <span class="slds-media__body">
                          <span class="slds-truncate">
                            <strong>{obj.label}</strong>
                            <span class="slds-text-color_weak slds-m-left_xx-small">({obj.apiName})</span>
                          </span>
                        </span>
                      </div>
                    </li>
                  </template>
                  <template if:true={contextObjectNoResults}>
                    <li role="presentation" class="slds-listbox__item">
                      <div class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small">
                        <span class="slds-media__body slds-text-color_weak">No results found</span>
                      </div>
                    </li>
                  </template>
                </ul>
              </div>
            </template>
          </div>
          <template if:true={contextObjectApiName}>
            <div class="slds-m-bottom_small">
              <lightning-record-picker
                label="Context Record"
                placeholder="Search for a record..."
                object-api-name={contextObjectApiName}
                onchange={handleContextRecordChange}
                data-id="context-record-picker"
              ></lightning-record-picker>
            </div>
          </template>
          <template if:true={mergeTokenStatusText}>
            <p class="slds-text-body_small slds-text-color_success slds-m-top_xx-small">
              {mergeTokenStatusText}
            </p>
          </template>
        </div>

        <!-- Preview -->
        <div class="slds-card slds-p-around_medium">
          <h3 class="slds-text-heading_small slds-m-bottom_small">Live Preview</h3>
          <template if:true={resolvedPreviewQueryString}>
            <p class="slds-m-bottom_small slds-text-body_small slds-text-color_weak">
              {resolvedPreviewQueryString}
            </p>
            <c-data360-table
              query-string={resolvedPreviewQueryString}
              column-labels={previewColumnLabels}
              show-record-count
            ></c-data360-table>
          </template>
          <template if:false={resolvedPreviewQueryString}>
            <div class="slds-align_absolute-center slds-p-around_large slds-text-color_weak">
              <template if:true={hasPendingMergeTokens}>
                Select a context record to resolve $record tokens
              </template>
              <template if:false={hasPendingMergeTokens}>
                Select an object and fields to see a preview
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </lightning-card>

  <!-- Delete Confirmation Modal -->
  <template if:true={showDeleteModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <h2 class="slds-modal__title">Confirm Delete</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          <p>Are you sure you want to delete the config "{configName}"?</p>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button label="Cancel" onclick={handleDeleteCancel}></lightning-button>
          <lightning-button label="Delete" variant="destructive" onclick={handleDeleteConfirm} class="slds-m-left_x-small"></lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <template if:true={isLoading}>
    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
  </template>
</template>
